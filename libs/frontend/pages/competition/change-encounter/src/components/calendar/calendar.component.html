<div class="header">
  <div class="top-row">
    <div class="buttons">
      <button mat-stroked-button (click)="setCurrentMonth()">Today</button>
      <button mat-icon-button (click)="decreaseMonth()">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <button mat-icon-button (click)="increaseMonth()">
        <mat-icon>chevron_right</mat-icon>
      </button>
      <div>
        {{ monthNames[firstDayOfMonth.get('month')] | titlecase }}
        {{ firstDayOfMonth.get('year') }}
      </div>
    </div>
    <div class="locations" fxLayoutAlign="center center">
      <mat-chip-listbox aria-label="Location selection">
        <mat-chip *ngFor="let loc of locations | keyvalue">
          <mat-chip-avatar>{{ loc.key }}</mat-chip-avatar>
          {{ loc.value.name }}</mat-chip
        >
      </mat-chip-listbox>
    </div>
    <div class="spacer"></div>
    <div class="manual-selection" *ngIf="this.data.home">
      <mat-form-field *ngIf="this.locations">
        <mat-label>{{
          'all.competition.change-encounter.choose-location' | translate
        }}</mat-label>
        <mat-select [formControl]="manualLocationControl">
          <mat-option
            *ngFor="let location of this.locations | keyvalue"
            [value]="location.value.id"
            >{{ location.value.name }}</mat-option
          >
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>{{
          'all.competition.change-encounter.choose-date' | translate
        }}</mat-label>
        <input
          matInput
          [ngxMatDatetimePicker]="openPicker"
          placeholder="Choose a date"
          [min]="this.minDate"
          [max]="this.maxDate"
          [formControl]="manualDateControl"
        />
        <mat-datepicker-toggle
          matSuffix
          [for]="$any(openPicker)"
        ></mat-datepicker-toggle>
        <ngx-mat-datetime-picker #openPicker> </ngx-mat-datetime-picker>
      </mat-form-field>

      <button
        mat-icon-button
        (click)="
          this.selectDay(
            manualDateControl.value,
            undefined,
            manualLocationControl.value
          )
        "
      >
        <mat-icon>check</mat-icon>
      </button>
    </div>
  </div>
  <div class="botton-row">
    <small>Klik op een uur om deze te selecteren</small> <br />
    <badman-has-claim
      [any]="[this.data.homeClubId + '_edit:club', 'edit-any:club']"
    >
      <small noPerm
        >Vraag aan de club verantwoordelijke om een Speelmomenten toe te
        voegen</small
      >
      <small
        >Speelmomenten wijzigen:
        <a
          [routerLink]="['/', 'club', this.data.homeClubId, 'edit']"
          (click)="this.dialogRef.close()"
          >Club > Edit > Locatie
        </a></small
      >
    </badman-has-claim>
  </div>
</div>

<div class="calendar">
  <div
    *ngIf="calendar; else loading"
    class="calendar-table"
    [ngStyle]="{ 'grid-template-columns': gridTemplateColumns }"
  >
    <div class="calendar-day weekday" *ngFor="let weekDay of weekDayNames">
      {{ weekDay | titlecase }}
    </div>

    <div
      *ngFor="let row of calendar"
      class="calendar-day"
      [ngClass]="{ 'past-date': row.isPastDate, today: row.isToday }"
    >
      <div class="calendar-day-header">
        <div fxFlex>
          <div class="selection">
            <span class="day">{{ row.date?.getDate() }}</span>
            <span
              class="momth"
              *ngIf="row.isToday || row.date?.getDate() === 1"
            >
              {{ monthNames[row.date?.getMonth() ?? 0] | titlecase }}</span
            >
          </div>
        </div>
      </div>

      <div class="calendar-day-content">
        <div
          *ngFor="let loc of row.locations"
          fxLayout="column"
          fxLayoutGap="5px"
        >
          <div *ngFor="let av of loc.availibility" fxLayout="column">
            <div
              *ngIf="av.remainingEncounters > 0 || this.data.home"
              class="location picable"
              fxFlex
              (click)="selectDay(row.date, av.startTime, loc.id)"
              matTooltip="Pick this moment"
            >
              <span class="id">{{ loc.showNumber }}</span>
              <span class="time">{{ av.startTime }} - </span>
              <span class="courts">
                {{
                  'all.competition.change-encounter.calendar.remaining'
                    | translate : { amount: av.remainingEncounters }
                }}
                <ng-container *ngIf="av.option">
                  ({{
                    'all.competition.change-encounter.calendar.option'
                      | translate : { amount: av.option }
                  }})
                </ng-container>
              </span>
            </div>

            <div
              *ngIf="av.remainingEncounters <= 0 && !this.data.home"
              class="location"
              fxFlex
            >
              <span class="id">{{ loc.showNumber }}</span>
              <span class="time">{{ av.startTime }} - </span>
              <span class="courts">
                {{
                  'all.competition.change-encounter.calendar.remaining'
                    | translate : { amount: av.remainingEncounters }
                }}
                <ng-container *ngIf="av.option">
                  ({{
                    'all.competition.change-encounter.calendar.option'
                      | translate : { amount: av.option }
                  }})
                </ng-container>
              </span>
            </div>

            <div
              role="button"
              class="event"
              *ngFor="let calEvent of av.events"
              [matTooltip]="
                'all.competition.change-encounter.calendar.removed' | translate
              "
              [matTooltipDisabled]="!calEvent.removed"
              [ngClass]="{
                removed: calEvent.removed
              }"
            >
              <div class="event-team">
                <div
                  [ngStyle]="{ 'border-color': calEvent.color }"
                  class="event-color"
                ></div>
              </div>
              <span fxFlex>
                <span
                  class="event-name"
                  fxFlex="0 1 auto"
                  [matTooltip]="
                    'all.competition.change-encounter.calendar.requested'
                      | translate
                  "
                  [matTooltipDisabled]="!calEvent.requested"
                >
                  <ng-container *ngIf="calEvent.ownTeam">
                    {{ calEvent?.encounter?.home?.abbreviation }}
                    {{ 'all.competition.vs-short' | translate }}
                    {{ calEvent?.encounter?.away?.name }}
                  </ng-container>

                  <ng-container *ngIf="!calEvent.ownTeam">
                    {{ calEvent?.encounter?.home?.name }}
                  </ng-container>

                  <span *ngIf="calEvent.requested">*</span>
                </span>
              </span>
            </div>
          </div>
        </div>

        <small *ngIf="row.otherEvents.length > 0">{{
          'all.competition.change-encounter.calendar.other-games' | translate
        }}</small>
        <div
          *ngFor="let calEvent of row.otherEvents"
          fxLayout="column"
          fxLayoutGap="5px"
        >
          <div
            fxFlex
            fxLayoutGap="3px"
            class="event"
            [matTooltip]="
              'all.competition.change-encounter.calendar.removed' | translate
            "
            [matTooltipDisabled]="!calEvent.removed"
            [ngClass]="{
              removed: calEvent.removed
            }"
          >
            <div class="event-team">
              <div
                [ngStyle]="{ 'border-color': calEvent.color }"
                class="event-color"
              ></div>
            </div>
            <span fxFlex>
              <span
                class="event-name"
                fxFlex="0 1 auto"
                [matTooltip]="
                  'all.competition.change-encounter.calendar.requested'
                    | translate
                "
                [matTooltipDisabled]="!calEvent.requested"
              >
                <ng-container *ngIf="calEvent.ownTeam">
                  {{ calEvent?.encounter?.home?.abbreviation }}
                  {{ 'all.competition.vs-short' | translate }}
                  {{ calEvent?.encounter?.away?.name }}
                </ng-container>

                <ng-container *ngIf="!calEvent.ownTeam">
                  {{ calEvent?.encounter?.home?.name }}
                </ng-container>

                <span *ngIf="calEvent.requested">*</span>
              </span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="sidebar" *ngIf="this.data.home">
    <div class="home-teams" *ngIf="this.homeTeams?.length">
      <div class="show">
        <button
          mat-stroked-button
          (click)="showAllTeams(this.homeTeams, this.data.homeClubId)"
        >
          Show all
        </button>
        <button mat-stroked-button (click)="hideAllTeams(this.data.homeClubId)">
          Hide all
        </button>
      </div>
      <div class="teams">
        <div *ngFor="let team of this.homeTeams">
          <mat-checkbox
            (change)="
              changeVisibleTeams($event, team.id!, this.data.homeClubId)
            "
            [checked]="visibleTeams?.[this.data.homeClubId]?.includes(team.id ?? '')"
            >{{ team.name }}</mat-checkbox
          >
        </div>
      </div>
    </div>

    <div class="away-teams" *ngIf="this.awayTeams?.length">
      <div class="show">
        <button
          mat-stroked-button
          (click)="showAllTeams(this.awayTeams, this.data.awayClubId)"
        >
          Show all
        </button>
        <button mat-stroked-button (click)="hideAllTeams(this.data.awayClubId)">
          Hide all
        </button>
      </div>
      <div class="teams">
        <div *ngFor="let team of this.awayTeams">
          <mat-checkbox
            (change)="
              changeVisibleTeams($event, team.id!, this.data.awayClubId)
            "
            [checked]="visibleTeams?.[this.data.awayClubId]?.includes(team.id ?? '')"
            >{{ team.name }}</mat-checkbox
          >
        </div>
      </div>
    </div>
  </div>
  <div class="sidebar" *ngIf="!this.data.home">
    <div class="home-teams" *ngIf="this.awayTeams?.length">
      <div class="show">
        <button
          mat-stroked-button
          (click)="showAllTeams(this.awayTeams, this.data.awayClubId)"
        >
          Show all
        </button>
        <button mat-stroked-button (click)="hideAllTeams(this.data.awayClubId)">
          Hide all
        </button>
      </div>
      <div class="teams">
        <div *ngFor="let team of this.awayTeams">
          <mat-checkbox
            (change)="
              changeVisibleTeams($event, team.id!, this.data.awayClubId)
            "
            [checked]="visibleTeams?.[this.data.awayClubId]?.includes(team.id ?? '')"
            >{{ team.name }}</mat-checkbox
          >
        </div>
      </div>
    </div>

    <div class="away-teams" *ngIf="this.homeTeams?.length">
      <div class="show">
        <button
          mat-stroked-button
          (click)="showAllTeams(this.homeTeams, this.data.homeClubId)"
        >
          Show all
        </button>
        <button mat-stroked-button (click)="hideAllTeams(this.data.homeClubId)">
          Hide all
        </button>
      </div>
      <div class="teams">
        <div *ngFor="let team of this.homeTeams">
          <mat-checkbox
            (change)="
              changeVisibleTeams($event, team.id!, this.data.homeClubId)
            "
            [checked]="visibleTeams?.[this.data.homeClubId]?.includes(team.id ?? '')"
            >{{ team.name }}</mat-checkbox
          >
        </div>
      </div>
    </div>
  </div>
</div>
<ng-template #loading>
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
</ng-template>
